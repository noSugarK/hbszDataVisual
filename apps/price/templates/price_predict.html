{% extends 'base.html' %}
{% load static %}

{% block title %}混凝土价格预测 - 数据可视化系统{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-bg: #f8fafc;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .predict-header {
            margin: 2rem 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .predict-header h2 {
            color: #1e293b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .predict-header p {
            color: var(--secondary-color);
            margin-top: 0.5rem;
            font-size: 1.05rem;
        }

        .controls-container {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }

        .control-group {
            flex: 1;
            min-width: 250px;
        }

        .control-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: #334155;
            font-size: 1rem;
        }

        .city-selector {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            color: #1e293b;
            background-color: white;
            transition: border-color var(--transition-speed);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }

        .city-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-predict {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
        }

        .btn-predict:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-predict:active {
            transform: translateY(0);
        }

        .status-container {
            margin-bottom: 1.5rem;
        }

        .rmse-info {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f1f5f9;
            color: #334155;
        }

        .rmse-info.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .rmse-info.loading {
            background-color: rgba(59, 130, 246, 0.1);
            color: #1e40af;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .rmse-info.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .chart-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .chart-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            font-size: 1.25rem;
        }

        .chart-meta {
            display: flex;
            gap: 1rem;
        }

        .metric-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-rmse {
            background-color: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .chart-container {
            width: 100%;
            height: 500px;
            padding: 1.5rem;
        }

        .chart-legend {
            display: flex;
            gap: 1.5rem;
            padding: 0 1.5rem 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #64748b;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .controls-container {
                flex-direction: column;
                gap: 1rem;
            }

            .control-group {
                width: 100%;
                min-width: auto;
            }

            .btn-predict {
                width: 100%;
                justify-content: center;
            }

            .chart-container {
                height: 400px;
                padding: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="predict-header">
                <h2>
                    <i class="fas fa-chart-line"></i>
                    混凝土价格预测（未来3个月）
                </h2>
                <p>基于历史数据使用 SARIMAX 模型预测，选择城市后点击按钮开始分析。</p>
            </div>

            <!-- 控制区域：城市选择和预测按钮 -->
            <div class="controls-container">
                <div class="control-group">
                    <label for="citySelector" class="control-label">选择城市</label>
                    <!-- 城市选择下拉框（单个选择） -->
                    <select id="citySelector" class="city-selector">
                        <option value="">-- 请选择城市 --</option>
                        <option value="wuhan">武汉市</option>
                        <option value="huanggang">黄冈市</option>
                        <option value="xiangyang">襄阳市</option>
                        <option value="shiyan">十堰市</option>
                        <option value="jingzhou">荆州市</option>
                        <option value="yichang">宜昌市</option>
                        <option value="enshi">恩施市</option>
                        <option value="suizhou">随州市</option>
                        <option value="jingmen">荆门市</option>
                        <option value="ezhou">鄂州市</option>
                        <option value="xiantao">仙桃市</option>
                        <option value="qianjiang">潜江市</option>
                        <option value="tianmen">天门市</option>
                        <option value="shennongjia">神农架</option>
                        <option value="xianning">咸宁市</option>
                        <option value="huangshi">黄石市</option>
                        <option value="xiaogan">孝感市</option>
                    </select>
                </div>

                <button class="btn-predict" onclick="runPrediction()">
                    <i class="fas fa-play-circle"></i> 开始预测
                </button>
            </div>

            <!-- 状态和RMSE显示 -->
            <div class="status-container">
                <div class="rmse-info" id="rmseInfo">
                    <i class="fas fa-info-circle"></i> 请选择城市并点击"开始预测"按钮
                </div>
            </div>

            <!-- 图表容器 -->
            <div id="charts" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <!-- 使用本地 Chart.js -->
    <script src="{% static 'chart.js-4.5.0/dist/chart.umd.js' %}"></script>
    <!-- SweetAlert2 弹窗 -->
    <script src="{% static 'sweetalert2/sweetalert2.all.min.js' %}"></script>

    <script>
        console.log("📌 页面加载完成，Chart.js 脚本已引入");

        // 城市英文到中文映射
        const cityNameMap = {
            'wuhan': '武汉市',
            'huanggang': '黄冈市',
            'xiangyang': '襄阳市',
            'shiyan': '十堰市',
            'jingzhou': '荆州市',
            'yichang': '宜昌市',
            'enshi': '恩施市',
            'suizhou': '随州市',
            'jingmen': '荆门市',
            'ezhou': '鄂州市',
            'xiantao': '仙桃市',
            'qianjiang': '潜江市',
            'tianmen': '天门市',
            'shennongjia': '神农架',
            'xianning': '咸宁市',
            'huangshi': '黄石市',
            'xiaogan': '孝感市'
        };

        // 获取选中的城市
        function getSelectedCity() {
            const selectElement = document.getElementById('citySelector');
            return selectElement.value;
        }

        // 开始预测
        function runPrediction() {
            console.log("✅ runPrediction() 被调用！");

            const selectedCity = getSelectedCity();
            const rmseInfo = document.getElementById('rmseInfo');

            // 验证是否选择了城市
            if (!selectedCity) {
                Swal.fire({
                    icon: 'warning',
                    title: '请选择城市',
                    text: '请从下拉菜单中选择一个城市进行预测',
                    confirmButtonColor: '#2563eb'
                });
                return;
            }

            // 更新状态信息
            rmseInfo.className = 'rmse-info loading';
            rmseInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 预测中，请稍候...';
            document.getElementById('charts').innerHTML = ''; // 清空旧图表

            // 显示加载弹窗
            Swal.fire({
                title: '正在预测',
                text: `正在计算 ${cityNameMap[selectedCity]} 的混凝土价格预测...`,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // 发送 POST 请求，包含选中的城市
            fetch('{% url "price:price_predict_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ city: selectedCity })
            })
            .then(response => {
                console.log("📬 收到响应:", response);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("📊 后端返回数据:", data);
                Swal.close();

                if (!data.success) {
                    Swal.fire({
                        icon: 'error',
                        title: '预测失败',
                        text: data.error || '预测过程中出现错误',
                        confirmButtonColor: '#2563eb'
                    });
                    rmseInfo.className = 'rmse-info error';
                    rmseInfo.innerHTML = `<i class="fas fa-exclamation-circle"></i> 预测失败：${data.error || '未知错误'}`;
                    return;
                }

                // 显示 RMSE
                rmseInfo.className = 'rmse-info success';
                rmseInfo.innerHTML = `<i class="fas fa-check-circle"></i> 预测完成！RMSE: ${data.data[selectedCity].rmse}`;

                // 动态生成图表
                const city = selectedCity;
                const result = data.data[city];
                const displayName = cityNameMap[city] || city;

                // 创建卡片容器
                const card = document.createElement('div');
                card.className = 'chart-card';
                card.innerHTML = `
                    <div class="chart-header">
                        <h3 class="chart-title">${displayName} 混凝土价格趋势与预测</h3>
                        <div class="chart-meta">
                            <span class="metric-badge metric-rmse">RMSE: ${result.rmse}</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-${city}"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(54, 162, 235, 1);"></div>
                            <span>历史数据</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(75, 192, 192, 1);"></div>
                            <span>测试预测</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(255, 99, 132, 1);"></div>
                            <span>未来预测</span>
                        </div>
                    </div>
                `;
                document.getElementById('charts').appendChild(card);

                // 渲染图表
                renderChartJS(city, result);
            })
            .catch(err => {
                console.error("❌ 请求失败:", err);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: '请求失败',
                    text: '无法连接到服务器，请稍后重试',
                    confirmButtonColor: '#2563eb'
                });
                rmseInfo.className = 'rmse-info error';
                rmseInfo.innerHTML = '<i class="fas fa-exclamation-circle"></i> 请求失败，请检查网络连接';
            });
        }

        // 使用 Chart.js 绘制图表
        function renderChartJS(city, result) {
            const ctx = document.getElementById(`chart-${city}`).getContext('2d');

            // 合并所有时间点，去重排序
            const allData = new Map();

            // 添加历史数据
            result.history.forEach(p => {
                allData.set(p.date, { date: p.date, history: p.value });
            });
            // 添加测试预测
            result.test_pred.forEach(p => {
                if (allData.has(p.date)) {
                    allData.get(p.date).test_pred = p.value;
                } else {
                    allData.set(p.date, { date: p.date, test_pred: p.value });
                }
            });
            // 添加未来预测
            result.forecast.forEach(p => {
                if (allData.has(p.date)) {
                    allData.get(p.date).forecast = p.value;
                } else {
                    allData.set(p.date, { date: p.date, forecast: p.value });
                }
            });

            const sortedData = Array.from(allData.values()).sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            // 准备数据
            const labels = sortedData.map(d => d.date);
            const historyData = sortedData.map(d => d.history || null);
            const testData = sortedData.map(d => d.test_pred || null);
            const forecastData = sortedData.map(d => d.forecast || null);

            // 绘制图表
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '历史数据',
                            data: historyData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.05)',
                            borderWidth: 2.5,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: '测试预测',
                            data: testData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.05)',
                            borderWidth: 2.5,
                            borderDash: [6, 4],
                            fill: false,
                            tension: 0.2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: '未来预测',
                            data: forecastData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日期',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                padding: { top: 15 }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 11 }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '价格 (元)',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                padding: { right: 15 }
                            },
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString('zh-CN');
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // 隐藏图表内置图例，使用自定义图例
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('zh-CN', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        }).format(context.parsed.y) + ' 元';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 获取CSRF令牌的辅助函数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}