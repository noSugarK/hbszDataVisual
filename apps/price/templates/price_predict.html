{% extends 'base.html' %}
{% load static %}

{% block title %}æ··å‡åœŸä»·æ ¼é¢„æµ‹ - æ•°æ®å¯è§†åŒ–ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-bg: #f8fafc;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .predict-header {
            margin: 2rem 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .predict-header h2 {
            color: #1e293b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .predict-header p {
            color: var(--secondary-color);
            margin-top: 0.5rem;
            font-size: 1.05rem;
        }

        .controls-container {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }

        .control-group {
            flex: 1;
            min-width: 250px;
        }

        .control-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: #334155;
            font-size: 1rem;
        }

        .city-selector {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            color: #1e293b;
            background-color: white;
            transition: border-color var(--transition-speed);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }

        .city-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-predict {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
        }

        .btn-predict:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-predict:active {
            transform: translateY(0);
        }

        .status-container {
            margin-bottom: 1.5rem;
        }

        .rmse-info {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f1f5f9;
            color: #334155;
        }

        .rmse-info.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .rmse-info.loading {
            background-color: rgba(59, 130, 246, 0.1);
            color: #1e40af;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .rmse-info.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .chart-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .chart-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            font-size: 1.25rem;
        }

        .chart-meta {
            display: flex;
            gap: 1rem;
        }

        .metric-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-rmse {
            background-color: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .chart-container {
            width: 100%;
            height: 500px;
            padding: 1.5rem;
        }

        .chart-legend {
            display: flex;
            gap: 1.5rem;
            padding: 0 1.5rem 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #64748b;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .controls-container {
                flex-direction: column;
                gap: 1rem;
            }

            .control-group {
                width: 100%;
                min-width: auto;
            }

            .btn-predict {
                width: 100%;
                justify-content: center;
            }

            .chart-container {
                height: 400px;
                padding: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="predict-header">
                <h2>
                    <i class="fas fa-chart-line"></i>
                    æ··å‡åœŸä»·æ ¼é¢„æµ‹ï¼ˆæœªæ¥3ä¸ªæœˆï¼‰
                </h2>
                <p>åŸºäºå†å²æ•°æ®ä½¿ç”¨ SARIMAX æ¨¡å‹é¢„æµ‹ï¼Œé€‰æ‹©åŸå¸‚åç‚¹å‡»æŒ‰é’®å¼€å§‹åˆ†æã€‚</p>
            </div>

            <!-- æ§åˆ¶åŒºåŸŸï¼šåŸå¸‚é€‰æ‹©å’Œé¢„æµ‹æŒ‰é’® -->
            <div class="controls-container">
                <div class="control-group">
                    <label for="citySelector" class="control-label">é€‰æ‹©åŸå¸‚</label>
                    <!-- åŸå¸‚é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆå•ä¸ªé€‰æ‹©ï¼‰ -->
                    <select id="citySelector" class="city-selector">
                        <option value="">-- è¯·é€‰æ‹©åŸå¸‚ --</option>
                        <option value="wuhan">æ­¦æ±‰å¸‚</option>
                        <option value="huanggang">é»„å†ˆå¸‚</option>
                        <option value="xiangyang">è¥„é˜³å¸‚</option>
                        <option value="shiyan">åå °å¸‚</option>
                        <option value="jingzhou">è†å·å¸‚</option>
                        <option value="yichang">å®œæ˜Œå¸‚</option>
                        <option value="enshi">æ©æ–½å¸‚</option>
                        <option value="suizhou">éšå·å¸‚</option>
                        <option value="jingmen">è†é—¨å¸‚</option>
                        <option value="ezhou">é„‚å·å¸‚</option>
                        <option value="xiantao">ä»™æ¡ƒå¸‚</option>
                        <option value="qianjiang">æ½œæ±Ÿå¸‚</option>
                        <option value="tianmen">å¤©é—¨å¸‚</option>
                        <option value="shennongjia">ç¥å†œæ¶</option>
                        <option value="xianning">å’¸å®å¸‚</option>
                        <option value="huangshi">é»„çŸ³å¸‚</option>
                        <option value="xiaogan">å­æ„Ÿå¸‚</option>
                    </select>
                </div>

                <button class="btn-predict" onclick="runPrediction()">
                    <i class="fas fa-play-circle"></i> å¼€å§‹é¢„æµ‹
                </button>
            </div>

            <!-- çŠ¶æ€å’ŒRMSEæ˜¾ç¤º -->
            <div class="status-container">
                <div class="rmse-info" id="rmseInfo">
                    <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©åŸå¸‚å¹¶ç‚¹å‡»"å¼€å§‹é¢„æµ‹"æŒ‰é’®
                </div>
            </div>

            <!-- å›¾è¡¨å®¹å™¨ -->
            <div id="charts" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <!-- ä½¿ç”¨æœ¬åœ° Chart.js -->
    <script src="{% static 'chart.js-4.5.0/dist/chart.umd.js' %}"></script>
    <!-- SweetAlert2 å¼¹çª— -->
    <script src="{% static 'sweetalert2/sweetalert2.all.min.js' %}"></script>

    <script>
        console.log("ğŸ“Œ é¡µé¢åŠ è½½å®Œæˆï¼ŒChart.js è„šæœ¬å·²å¼•å…¥");

        // åŸå¸‚è‹±æ–‡åˆ°ä¸­æ–‡æ˜ å°„
        const cityNameMap = {
            'wuhan': 'æ­¦æ±‰å¸‚',
            'huanggang': 'é»„å†ˆå¸‚',
            'xiangyang': 'è¥„é˜³å¸‚',
            'shiyan': 'åå °å¸‚',
            'jingzhou': 'è†å·å¸‚',
            'yichang': 'å®œæ˜Œå¸‚',
            'enshi': 'æ©æ–½å¸‚',
            'suizhou': 'éšå·å¸‚',
            'jingmen': 'è†é—¨å¸‚',
            'ezhou': 'é„‚å·å¸‚',
            'xiantao': 'ä»™æ¡ƒå¸‚',
            'qianjiang': 'æ½œæ±Ÿå¸‚',
            'tianmen': 'å¤©é—¨å¸‚',
            'shennongjia': 'ç¥å†œæ¶',
            'xianning': 'å’¸å®å¸‚',
            'huangshi': 'é»„çŸ³å¸‚',
            'xiaogan': 'å­æ„Ÿå¸‚'
        };

        // è·å–é€‰ä¸­çš„åŸå¸‚
        function getSelectedCity() {
            const selectElement = document.getElementById('citySelector');
            return selectElement.value;
        }

        // å¼€å§‹é¢„æµ‹
        function runPrediction() {
            console.log("âœ… runPrediction() è¢«è°ƒç”¨ï¼");

            const selectedCity = getSelectedCity();
            const rmseInfo = document.getElementById('rmseInfo');

            // éªŒè¯æ˜¯å¦é€‰æ‹©äº†åŸå¸‚
            if (!selectedCity) {
                Swal.fire({
                    icon: 'warning',
                    title: 'è¯·é€‰æ‹©åŸå¸‚',
                    text: 'è¯·ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€ä¸ªåŸå¸‚è¿›è¡Œé¢„æµ‹',
                    confirmButtonColor: '#2563eb'
                });
                return;
            }

            // æ›´æ–°çŠ¶æ€ä¿¡æ¯
            rmseInfo.className = 'rmse-info loading';
            rmseInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é¢„æµ‹ä¸­ï¼Œè¯·ç¨å€™...';
            document.getElementById('charts').innerHTML = ''; // æ¸…ç©ºæ—§å›¾è¡¨

            // æ˜¾ç¤ºåŠ è½½å¼¹çª—
            Swal.fire({
                title: 'æ­£åœ¨é¢„æµ‹',
                text: `æ­£åœ¨è®¡ç®— ${cityNameMap[selectedCity]} çš„æ··å‡åœŸä»·æ ¼é¢„æµ‹...`,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // å‘é€ POST è¯·æ±‚ï¼ŒåŒ…å«é€‰ä¸­çš„åŸå¸‚
            fetch('{% url "price:price_predict_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ city: selectedCity })
            })
            .then(response => {
                console.log("ğŸ“¬ æ”¶åˆ°å“åº”:", response);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("ğŸ“Š åç«¯è¿”å›æ•°æ®:", data);
                Swal.close();

                if (!data.success) {
                    Swal.fire({
                        icon: 'error',
                        title: 'é¢„æµ‹å¤±è´¥',
                        text: data.error || 'é¢„æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',
                        confirmButtonColor: '#2563eb'
                    });
                    rmseInfo.className = 'rmse-info error';
                    rmseInfo.innerHTML = `<i class="fas fa-exclamation-circle"></i> é¢„æµ‹å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                    return;
                }

                // æ˜¾ç¤º RMSE
                rmseInfo.className = 'rmse-info success';
                rmseInfo.innerHTML = `<i class="fas fa-check-circle"></i> é¢„æµ‹å®Œæˆï¼RMSE: ${data.data[selectedCity].rmse}`;

                // åŠ¨æ€ç”Ÿæˆå›¾è¡¨
                const city = selectedCity;
                const result = data.data[city];
                const displayName = cityNameMap[city] || city;

                // åˆ›å»ºå¡ç‰‡å®¹å™¨
                const card = document.createElement('div');
                card.className = 'chart-card';
                card.innerHTML = `
                    <div class="chart-header">
                        <h3 class="chart-title">${displayName} æ··å‡åœŸä»·æ ¼è¶‹åŠ¿ä¸é¢„æµ‹</h3>
                        <div class="chart-meta">
                            <span class="metric-badge metric-rmse">RMSE: ${result.rmse}</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-${city}"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(54, 162, 235, 1);"></div>
                            <span>å†å²æ•°æ®</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(75, 192, 192, 1);"></div>
                            <span>æµ‹è¯•é¢„æµ‹</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(255, 99, 132, 1);"></div>
                            <span>æœªæ¥é¢„æµ‹</span>
                        </div>
                    </div>
                `;
                document.getElementById('charts').appendChild(card);

                // æ¸²æŸ“å›¾è¡¨
                renderChartJS(city, result);
            })
            .catch(err => {
                console.error("âŒ è¯·æ±‚å¤±è´¥:", err);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'è¯·æ±‚å¤±è´¥',
                    text: 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•',
                    confirmButtonColor: '#2563eb'
                });
                rmseInfo.className = 'rmse-info error';
                rmseInfo.innerHTML = '<i class="fas fa-exclamation-circle"></i> è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            });
        }

        // ä½¿ç”¨ Chart.js ç»˜åˆ¶å›¾è¡¨
        function renderChartJS(city, result) {
            const ctx = document.getElementById(`chart-${city}`).getContext('2d');

            // åˆå¹¶æ‰€æœ‰æ—¶é—´ç‚¹ï¼Œå»é‡æ’åº
            const allData = new Map();

            // æ·»åŠ å†å²æ•°æ®
            result.history.forEach(p => {
                allData.set(p.date, { date: p.date, history: p.value });
            });
            // æ·»åŠ æµ‹è¯•é¢„æµ‹
            result.test_pred.forEach(p => {
                if (allData.has(p.date)) {
                    allData.get(p.date).test_pred = p.value;
                } else {
                    allData.set(p.date, { date: p.date, test_pred: p.value });
                }
            });
            // æ·»åŠ æœªæ¥é¢„æµ‹
            result.forecast.forEach(p => {
                if (allData.has(p.date)) {
                    allData.get(p.date).forecast = p.value;
                } else {
                    allData.set(p.date, { date: p.date, forecast: p.value });
                }
            });

            const sortedData = Array.from(allData.values()).sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            // å‡†å¤‡æ•°æ®
            const labels = sortedData.map(d => d.date);
            const historyData = sortedData.map(d => d.history || null);
            const testData = sortedData.map(d => d.test_pred || null);
            const forecastData = sortedData.map(d => d.forecast || null);

            // ç»˜åˆ¶å›¾è¡¨
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å†å²æ•°æ®',
                            data: historyData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.05)',
                            borderWidth: 2.5,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'æµ‹è¯•é¢„æµ‹',
                            data: testData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.05)',
                            borderWidth: 2.5,
                            borderDash: [6, 4],
                            fill: false,
                            tension: 0.2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'æœªæ¥é¢„æµ‹',
                            data: forecastData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                padding: { top: 15 }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 11 }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ä»·æ ¼ (å…ƒ)',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                padding: { right: 15 }
                            },
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString('zh-CN');
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // éšè—å›¾è¡¨å†…ç½®å›¾ä¾‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰å›¾ä¾‹
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('zh-CN', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        }).format(context.parsed.y) + ' å…ƒ';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // è·å–CSRFä»¤ç‰Œçš„è¾…åŠ©å‡½æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}