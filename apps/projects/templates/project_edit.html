<!-- apps/projects/templates/project_edit.html -->
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ title }}</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <!-- 项目名称选择（包含地区信息） -->
                        <div class="form-group">
                            <label for="id_project_mapping">项目名称:</label>
                            <select name="project_mapping" id="id_project_mapping" class="form-control">
                                <option value="">---------</option>
                                {% for mapping in project_mappings %}
                                <option value="{{ mapping.id }}" {% if project.project_mapping.id == mapping.id %}selected{% endif %}>
                                    {{ mapping.project_name }}
                                    {% if mapping.region %}
                                        ({{ mapping.region }})
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="project-info" class="project-info" style="display: none;">
                                <strong>项目信息:</strong>
                                <div id="region-info"></div>
                            </div>
                        </div>

                        <!-- 到货日期 -->
                        <div class="form-group">
                            <label for="id_arrival_date">到货日期:</label>
                            <input type="date" name="arrival_date" id="id_arrival_date" class="form-control" value="{{ project.arrival_date|date:'Y-m-d' }}" required>
                        </div>

                        <!-- 供应商选择 -->
                        <div class="form-group">
                            <label for="id_supplier">供应商:</label>
                            <select name="supplier" id="id_supplier" class="form-control" required>
                                <option value="">---------</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if project.supplier.id == supplier.id %}selected{% endif %}>{{ supplier.supplier_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- 物资类别 -->
                        <div class="form-group">
                            <label for="id_category">物资类别:</label>
                            <select name="category" id="id_category" class="form-control">
                                <option value="">---------</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if project.category.id == category.id %}selected{% endif %}>{{ category.category_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- 规格 -->
                        <div class="form-group">
                            <label for="id_specification">规格:</label>
                            <select name="specification" id="id_specification" class="form-control">
                                <option value="">---------</option>
                                {% if project.category %}
                                    {% for spec in project.category.specification_set.all %}
                                    <option value="{{ spec.id }}" {% if project.specification.id == spec.id %}selected{% endif %}>{{ spec.specification_name }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>

                        <!-- 数量 -->
                        <div class="form-group">
                            <label for="id_quantity">数量:</label>
                            <input type="number" name="quantity" id="id_quantity" class="form-control" step="0.01" value="{{ project.quantity }}" required>
                        </div>

                        <!-- 单价 -->
                        <div class="form-group">
                            <label for="id_unit_price">单价:</label>
                            <input type="number" name="unit_price" id="id_unit_price" class="form-control" step="0.01" value="{{ project.unit_price }}" required>
                        </div>

                        <!-- 下浮率 -->
                        <div class="form-group">
                            <label for="id_discount_rate">下浮率:</label>
                            <input type="number" name="discount_rate" id="id_discount_rate" class="form-control" step="0.01" value="{{ project.discount_rate|default:0 }}" placeholder="可选">
                        </div>

                        <!-- 品牌 -->
                        <div class="form-group">
                            <label for="id_brand">品牌:</label>
                            <select name="brand" id="id_brand" class="form-control">
                                <option value="">---------</option>
                                {% for brand in brands %}
                                <option value="{{ brand.id }}" {% if project.brand.id == brand.id %}selected{% endif %}>{{ brand.brand_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">更新项目</button>
                        <a href="{% url 'projects:project_detail' project.id %}" class="btn btn-secondary" style="margin-left: 10px;">取消</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group select,
    .form-group input {
        width: 300px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .form-group input[type="date"] {
        width: 150px;
    }

    .form-group input[type="number"] {
        width: 150px;
    }

    .project-info {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 项目映射选择改变时显示地区信息
    $('#id_project_mapping').change(function() {
        var selectedOption = $(this).find('option:selected');
        var projectInfo = $('#project-info');
        var regionInfo = $('#region-info');

        if ($(this).val()) {
            var text = selectedOption.text();
            var regionMatch = text.match(/\((.*?)\)$/);

            if (regionMatch) {
                regionInfo.text('地区: ' + regionMatch[1]);
                projectInfo.show();
            } else {
                projectInfo.hide();
            }
        } else {
            projectInfo.hide();
        }
    });

    // 物资类别选择改变时更新规格选项
    $('#id_category').change(function() {
        var categoryId = $(this).val();
        var specificationSelect = $('#id_specification');

        if (categoryId) {
            // 启用规格选择框
            specificationSelect.empty().append('<option value="">加载中...</option>');

            $.ajax({
                url: '{% url "projects:get_specifications" %}',
                data: {'category_id': categoryId},
                success: function(data) {
                    specificationSelect.empty();
                    if (data.specifications.length > 0) {
                        specificationSelect.append('<option value="">---------</option>');
                        $.each(data.specifications, function(index, specification) {
                            specificationSelect.append('<option value="' + specification.id + '">' + specification.name + '</option>');
                        });
                    } else {
                        specificationSelect.append('<option value="">该类别无规格</option>');
                    }
                },
                error: function() {
                    alert('获取规格列表失败');
                    specificationSelect.empty().append('<option value="">加载失败</option>');
                }
            });
        } else {
            // 如果没有选择类别，清空规格选择框
            specificationSelect.empty().append('<option value="">---------</option>');
        }
    });

    // 初始化时触发一次项目映射选择事件
    $('#id_project_mapping').trigger('change');
});
</script>
{% endblock %}
