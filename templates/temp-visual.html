<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目价格与信息价可视化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        neutral: '#86909C',
                        light: '#F2F3F5',
                        dark: '#1D2129'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .select-dropdown {
                @apply appearance-none bg-white border border-gray-300 rounded-md py-2 pl-3 pr-8 leading-tight focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .card-shadow {
                @apply shadow-lg hover:shadow-xl transition-shadow duration-300;
            }
            .chart-container {
                @apply relative h-[600px] w-full overflow-x-auto pb-6;
            }
            .chart-wrapper {
                @apply min-h-full;
            }
            .multi-select-item {
                @apply flex items-center p-2 hover:bg-light rounded cursor-pointer transition-colors;
            }
            .multi-select-item.selected {
                @apply bg-primary/10 text-primary;
            }
            .date-input {
                @apply border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark">
    <!-- 页面头部 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">
                <i class="fa fa-line-chart text-primary mr-2"></i>项目价格与信息价可视化
            </h1>
            <p class="text-neutral mt-1">分析不同地区项目价格与信息价走势</p>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 筛选条件区域 -->
        <section class="bg-white rounded-xl p-6 mb-8 card-shadow">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-filter text-primary mr-2"></i>筛选条件
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 地区选择 - 多选下拉框 -->
                <div>
                    <label class="block text-sm font-medium text-neutral mb-1">选择地区 (可多选)</label>
                    <div class="relative" id="region-select-container">
                        <input type="text" placeholder="选择地区" readonly
                               class="select-dropdown w-full cursor-pointer" id="region-display">
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-neutral">
                            <i class="fa fa-chevron-down text-xs"></i>
                        </div>
                        <!-- 下拉选项 -->
                        <div class="hidden absolute top-full left-0 right-0 mt-1 bg-white shadow-lg rounded-md z-10 max-h-60 overflow-y-auto" id="region-dropdown">
                            <!-- 选项将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 日期范围选择 -->
                <div>
                    <label class="block text-sm font-medium text-neutral mb-1">选择日期范围</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="start-date" class="block text-xs text-neutral mb-1">开始日期</label>
                            <input type="month" id="start-date" class="date-input w-full">
                        </div>
                        <div>
                            <label for="end-date" class="block text-xs text-neutral mb-1">结束日期</label>
                            <input type="month" id="end-date" class="date-input w-full">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 按钮区域 -->
            <div class="mt-6 flex flex-wrap gap-3">
                <button id="apply-filters" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-md transition-colors duration-200 flex items-center">
                    <i class="fa fa-check mr-2"></i>应用筛选
                </button>
                <button id="reset-filters" class="bg-white border border-gray-300 hover:bg-gray-50 text-dark px-6 py-2 rounded-md transition-colors duration-200 flex items-center">
                    <i class="fa fa-refresh mr-2"></i>重置筛选
                </button>
            </div>
        </section>

        <!-- 图表展示区域 -->
        <section class="bg-white rounded-xl p-6 card-shadow">
            <div class="flex justify-between items-center mb-6">
                <h2 id="chart-title" class="text-xl font-semibold flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>月份-价格图
                </h2>
                <div class="text-sm text-neutral" id="chart-info">
                    显示: <span id="display-details">所有地区，最近3个月</span>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-wrapper" id="chart-wrapper">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>

            <div class="mt-4 text-sm text-neutral flex items-center">
                <i class="fa fa-info-circle mr-1"></i>
                <span>提示：项目较多时可横向拖动查看全部数据</span>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-12 py-6">
        <div class="container mx-auto px-4 text-center">
            <p>项目价格与信息价可视化工具 &copy; 2023</p>
            <p class="text-gray-400 text-sm mt-1">数据仅供参考，实际价格以市场为准</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let priceChart = null;
        const referencePriceColor = '#FF4D4F'; // 信息价线颜色
        const CHART_HEIGHT = 600; // 图表固定高度
        let selectedRegions = [];

        // 模拟数据
        const projectData = [
            { name: '项目A', date: '2023-01', price: 1200 },
            { name: '项目A', date: '2023-02', price: 1250 },
            { name: '项目A', date: '2023-03', price: 1300 },
            { name: '项目A', date: '2023-04', price: 1280 },
            { name: '项目A', date: '2023-05', price: 1350 },
            { name: '项目B', date: '2023-01', price: 900 },
            { name: '项目B', date: '2023-02', price: 920 },
            { name: '项目B', date: '2023-03', price: 950 },
            { name: '项目B', date: '2023-04', price: 940 },
            { name: '项目B', date: '2023-05', price: 980 },
            { name: '项目C', date: '2023-01', price: 1500 },
            { name: '项目C', date: '2023-02', price: 1550 },
            { name: '项目C', date: '2023-03', price: 1600 },
            { name: '项目C', date: '2023-04', price: 1580 },
            { name: '项目C', date: '2023-05', price: 1650 },
            { name: '项目D', date: '2023-01', price: 800 },
            { name: '项目D', date: '2023-02', price: 820 },
            { name: '项目D', date: '2023-03', price: 850 },
            { name: '项目D', date: '2023-04', price: 840 },
            { name: '项目D', date: '2023-05', price: 880 },
            { name: '项目E', date: '2023-01', price: 1100 },
            { name: '项目E', date: '2023-02', price: 1120 },
            { name: '项目E', date: '2023-03', price: 1150 },
            { name: '项目E', date: '2023-04', price: 1140 },
            { name: '项目E', date: '2023-05', price: 1180 },
            { name: '项目F', date: '2023-01', price: 1300 },
            { name: '项目F', date: '2023-02', price: 1330 },
            { name: '项目F', date: '2023-03', price: 1370 },
            { name: '项目F', date: '2023-04', price: 1350 },
            { name: '项目F', date: '2023-05', price: 1400 },
        ];

        const projectMap = [
            { name: '项目A', region: '武汉市' },
            { name: '项目B', region: '武汉市' },
            { name: '项目C', region: '黄冈市' },
            { name: '项目D', region: '黄冈市' },
            { name: '项目E', region: '武汉市' },
            { name: '项目F', region: '黄冈市' },
        ];

        const referencePriceData = [
            { date: '2023-01', '武汉市': 1000, '黄冈市': 900 },
            { date: '2023-02', '武汉市': 1050, '黄冈市': 930 },
            { date: '2023-03', '武汉市': 1100, '黄冈市': 960 },
            { date: '2023-04', '武汉市': 1080, '黄冈市': 950 },
            { date: '2023-05', '武汉市': 1150, '黄冈市': 1000 },
        ];

        // 初始化函数
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化地区选择下拉框
            initRegionSelect();

            // 初始化日期选择器 - 默认最近3个月
            initDateRange();

            // 初始化图表
            updateChart();

            // 绑定事件监听
            document.getElementById('apply-filters').addEventListener('click', updateChart);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);

            // 点击页面其他地方关闭下拉框
            document.addEventListener('click', function(event) {
                const container = document.getElementById('region-select-container');
                if (!container.contains(event.target)) {
                    document.getElementById('region-dropdown').classList.add('hidden');
                }
            });
        });

        // 初始化地区选择下拉框
        function initRegionSelect() {
            const regions = [...new Set(projectMap.map(item => item.region))];
            const dropdown = document.getElementById('region-dropdown');
            const displayInput = document.getElementById('region-display');

            // 生成地区选项
            regions.forEach(region => {
                const item = document.createElement('div');
                item.className = 'multi-select-item';
                item.dataset.region = region;
                item.innerHTML = `
                    <i class="fa fa-check-circle-o mr-2"></i>
                    <span>${region}</span>
                `;

                // 点击选择/取消选择
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    item.classList.toggle('selected');

                    if (item.classList.contains('selected')) {
                        item.innerHTML = `
                            <i class="fa fa-check-circle mr-2"></i>
                            <span>${region}</span>
                        `;
                        if (!selectedRegions.includes(region)) {
                            selectedRegions.push(region);
                        }
                    } else {
                        item.innerHTML = `
                            <i class="fa fa-check-circle-o mr-2"></i>
                            <span>${region}</span>
                        `;
                        selectedRegions = selectedRegions.filter(r => r !== region);
                    }

                    // 更新显示
                    updateRegionDisplay();
                });

                dropdown.appendChild(item);
            });

            // 点击输入框显示/隐藏下拉框
            displayInput.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });

            // 默认全选
            selectedRegions = [...regions];
            document.querySelectorAll('.multi-select-item').forEach(item => {
                item.classList.add('selected');
                item.innerHTML = `
                    <i class="fa fa-check-circle mr-2"></i>
                    <span>${item.dataset.region}</span>
                `;
            });
            updateRegionDisplay();
        }

        // 更新地区选择显示
        function updateRegionDisplay() {
            const displayInput = document.getElementById('region-display');
            if (selectedRegions.length === 0) {
                displayInput.placeholder = '选择地区';
            } else if (selectedRegions.length <= 2) {
                displayInput.value = selectedRegions.join(', ');
            } else {
                displayInput.value = `${selectedRegions[0]}, ${selectedRegions[1]} 等 ${selectedRegions.length} 个地区`;
            }
        }

        // 初始化日期范围选择器 - 默认最近3个月
        function initDateRange() {
            // 获取所有月份并排序
            const allMonths = [...new Set(projectData.map(item => item.date))].sort();
            const today = new Date();

            // 计算3个月前的日期
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);

            // 格式化日期为YYYY-MM格式
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            };

            const endDateInput = document.getElementById('end-date');
            const startDateInput = document.getElementById('start-date');

            // 设置默认值 - 最近3个月或数据中的最大范围
            const latestMonth = allMonths[allMonths.length - 1] || formatDate(today);
            const earliestMonth = allMonths[0] || formatDate(threeMonthsAgo);

            // 确保开始日期不早于最早数据日期
            const defaultStartMonth = allMonths.length >= 3 ? allMonths[allMonths.length - 3] : earliestMonth;

            endDateInput.value = latestMonth;
            startDateInput.value = defaultStartMonth;
        }

        // 获取选中的筛选条件
        function getSelectedFilters() {
            // 获取选中的地区
            const regions = selectedRegions;

            // 获取选中的日期范围
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // 获取该范围内的所有月份
            const allMonths = [...new Set(projectData.map(item => item.date))].sort();
            const filteredMonths = allMonths.filter(month => {
                return month >= startDate && month <= endDate;
            });

            // 获取所有项目
            const allProjects = [...new Set(projectData.map(item => item.name))];

            return {
                regions: regions,
                months: filteredMonths,
                projects: allProjects
            };
        }

        // 重置筛选条件
        function resetFilters() {
            // 重置地区选择
            const regions = [...new Set(projectMap.map(item => item.region))];
            selectedRegions = [...regions];
            document.querySelectorAll('.multi-select-item').forEach(item => {
                item.classList.add('selected');
                item.innerHTML = `
                    <i class="fa fa-check-circle mr-2"></i>
                    <span>${item.dataset.region}</span>
                `;
            });
            updateRegionDisplay();

            // 重置日期选择
            initDateRange();

            // 更新图表
            updateChart();
        }

        // 更新图表
        function updateChart() {
            const filters = getSelectedFilters();
            updateChartInfo(filters);

            // 根据选择的月份数量决定图表类型
            const isSingleMonth = filters.months.length === 1;

            // 更新图表标题
            document.getElementById('chart-title').innerHTML = isSingleMonth
                ? '<i class="fa fa-bar-chart text-primary mr-2"></i>月份-价格图'
                : '<i class="fa fa-line-chart text-primary mr-2"></i>项目-价格图';

            // 准备图表数据
            const chartData = isSingleMonth ? prepareSingleMonthData(filters) : prepareMultipleMonthsData(filters);

            // 销毁现有图表（如果存在）
            if (priceChart) {
                priceChart.destroy();
            }

            // 设置图表容器宽度
            const chartWrapper = document.getElementById('chart-wrapper');
            const projectCount = isSingleMonth ?
                [...new Set(projectData.filter(item =>
                    filters.projects.includes(item.name) &&
                    item.date === filters.months[0] &&
                    filters.regions.includes(getProjectRegion(item.name))
                ).map(item => item.name))].length :
                filters.months.length;

            // 根据项目数量动态设置容器宽度
            const baseWidth = 800;
            const itemWidth = 100;
            const containerWidth = Math.max(baseWidth, projectCount * itemWidth);
            chartWrapper.style.width = `${containerWidth}px`;

            // 创建新图表
            const ctx = document.getElementById('price-chart').getContext('2d');
            priceChart = new Chart(ctx, chartData);
        }

        // 获取项目对应的地区
        function getProjectRegion(projectName) {
            const project = projectMap.find(p => p.name === projectName);
            return project ? project.region : '';
        }

        // 调整颜色明暗度和透明度的辅助函数
        function adjustColor(color, percent, alpha = 1) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            // 调整颜色明暗度
            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            // 确保颜色值在有效范围内
            R = Math.min(255, Math.max(0, R));
            G = Math.min(255, Math.max(0, G));
            B = Math.min(255, Math.max(0, B));

            R = Math.round(R);
            G = Math.round(G);
            B = Math.round(B);

            // 转换为带透明度的RGBA格式
            return `rgba(${R}, ${G}, ${B}, ${alpha})`;
        }

        // 准备单月数据 - 信息价在最上层，柱状图颜色淡化
        function prepareSingleMonthData(filters) {
            const [selectedMonth] = filters.months;

            // 获取符合条件的项目数据
            const filteredProjects = projectData.filter(item =>
                filters.projects.includes(item.name) &&
                item.date === selectedMonth &&
                filters.regions.includes(getProjectRegion(item.name))
            );

            // 准备图表数据
            const datasets = [];
            const projectNames = [...new Set(filteredProjects.map(item => item.name))].sort();
            const colors = getDistinctColors(projectNames.length);

            // 添加项目数据（柱状图）- 颜色淡化处理
            const projectPrices = projectNames.map(project => {
                const item = filteredProjects.find(p => p.name === project);
                return item ? item.price : 0;
            });

            // 柱状图使用较浅的颜色（透明度0.6）
            const lightColors = colors.map(color => adjustColor(color, 20, 0.6));
            const borderColors = colors.map(color => adjustColor(color, -10, 0.8));

            datasets.push({
                type: 'bar',
                label: '项目价格',
                data: projectPrices,
                backgroundColor: lightColors, // 淡化的填充色
                borderColor: borderColors,    // 稍深一点的边框
                borderWidth: 1,
                barPercentage: 0.6,
                categoryPercentage: 0.8,
                order: 2 // 柱状图在后层
            });

            // 添加信息价数据（折线图）- 显示在最上层
            const referenceData = projectNames.map(project => {
                const region = getProjectRegion(project);
                const refPriceItem = referencePriceData.find(item => item.date === selectedMonth);
                return refPriceItem ? refPriceItem[region] || 0 : 0;
            });

            datasets.push({
                type: 'line',
                label: '地区信息价',
                data: referenceData,
                borderColor: referencePriceColor,
                backgroundColor: referencePriceColor,
                borderWidth: 3, // 加粗信息价线
                pointBackgroundColor: referencePriceColor,
                pointRadius: 6,
                pointHoverRadius: 8,
                fill: false,
                tension: 0.1,
                order: 1 // 信息价在前层，显示在柱状图上方
            });

            return {
                type: 'bar',
                data: {
                    labels: projectNames,  // 横坐标为项目名称
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: CHART_HEIGHT,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '单价'
                            },
                            position: 'left',
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '项目名称'
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            };
        }

        // 准备多月数据
        function prepareMultipleMonthsData(filters) {
            // 按日期排序月份
            const sortedMonths = [...filters.months].sort();

            // 获取符合条件的项目
            const filteredProjectNames = [...new Set(projectData
                .filter(item =>
                    filters.projects.includes(item.name) &&
                    filters.months.includes(item.date) &&
                    filters.regions.includes(getProjectRegion(item.name))
                )
                .map(item => item.name))];

            // 准备图表数据
            const datasets = [];
            const colors = getDistinctColors(filteredProjectNames.length);

            // 添加项目数据（折线图）- 颜色淡化
            filteredProjectNames.forEach((project, index) => {
                const data = sortedMonths.map(month => {
                    const item = projectData.find(p => p.name === project && p.date === month);
                    return item ? item.price : null;
                });

                // 项目线颜色淡化
                const lightColor = adjustColor(colors[index], 10, 0.8);

                datasets.push({
                    type: 'line',
                    label: project,
                    data: data,
                    borderColor: lightColor,
                    backgroundColor: lightColor,
                    borderWidth: 2,
                    pointBackgroundColor: lightColor,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.1,
                    order: 2 // 项目线在后层
                });
            });

            // 添加各地区信息价数据（折线图）- 显示在最上层
            filters.regions.forEach(region => {
                const data = sortedMonths.map(month => {
                    const item = referencePriceData.find(p => p.date === month);
                    return item ? item[region] : null;
                });

                datasets.push({
                    type: 'line',
                    label: `${region} 信息价`,
                    data: data,
                    borderColor: referencePriceColor,
                    backgroundColor: referencePriceColor,
                    borderWidth: 3, // 加粗信息价线
                    pointBackgroundColor: referencePriceColor,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    fill: false,
                    tension: 0.1,
                    borderDash: [5, 5],
                    order: 1 // 信息价线在前层
                });
            });

            return {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: CHART_HEIGHT,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '单价'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            };
        }

        // 更新图表信息显示
        function updateChartInfo(filters) {
            const regionText = filters.regions.length > 3
                ? `${filters.regions.slice(0, 3).join(', ')} 等 ${filters.regions.length} 个地区`
                : filters.regions.join(', ');

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const monthText = `${startDate} 至 ${endDate}`;

            document.getElementById('display-details').textContent = `${regionText}，${monthText}`;
        }

        // 生成不同的颜色
        function getDistinctColors(count) {
            const colors = [
                '#165DFF', '#36CFC9', '#722ED1', '#FF7D00', '#F5222D', '#FAAD14',
                '#52C41A', '#1890FF', '#7B61FF', '#FF5722', '#EB2F96', '#00B42A',
                '#8B4513', '#20B2AA', '#FF6347', '#4682B4', '#BA55D3', '#F0E68C'
            ];

            // 如果需要的颜色超过预定义的，循环使用
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }

            return result;
        }
    </script>
</body>
</html>
